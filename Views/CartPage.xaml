<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:vm="clr-namespace:KPO_Cursovoy.ViewModels"
    xmlns:models="clr-namespace:KPO_Cursovoy.Models"
    x:Class="KPO_Cursovoy.Views.CartPage"
    x:Name="CartRoot"
    Title="Корзина"
    BackgroundColor="#020617">

    <Grid RowDefinitions="*,Auto"
          BackgroundColor="#020617">

        <RefreshView Grid.Row="0"
                     Command="{Binding RefreshCommand}"
                     IsRefreshing="{Binding IsBusy}">
            <CollectionView
                ItemsSource="{Binding Items}"
                SelectionMode="None">

                <CollectionView.EmptyView>
                    <VerticalStackLayout Spacing="20"
                                         Padding="30"
                                         HorizontalOptions="Center"
                                         VerticalOptions="Center"
                                         BindingContext="{Binding Source={x:Reference CartRoot}}">
                        <Image Source="emptycart.png"
                               HeightRequest="150"
                               HorizontalOptions="Center" />
                        <Label Text="Корзина пуста"
                               FontSize="24"
                               FontAttributes="Bold"
                               TextColor="#F9FAFB"
                               HorizontalOptions="Center" />
                        <Label Text="Перейдите в каталог, чтобы добавить товары."
                               FontSize="16"
                               TextColor="#64748B"
                               HorizontalOptions="Center" />
                    </VerticalStackLayout>
                </CollectionView.EmptyView>

                <CollectionView.ItemTemplate>
                    <DataTemplate>
                        <Frame Padding="15"
                               Margin="10"
                               BorderColor="#E2E8F0"
                               CornerRadius="12"
                               HasShadow="True"
                               BackgroundColor="#020617">
                            <Grid ColumnDefinitions="Auto,*,Auto"
                                  RowDefinitions="Auto,Auto,Auto">

                                <Image Source="pcthumbnail.png"
                                       WidthRequest="80"
                                       HeightRequest="80"
                                       Aspect="AspectFit"
                                       Grid.RowSpan="3" />

                                <Label Text="{Binding Pc.Name, FallbackValue='Товар'}"
                                       FontSize="18"
                                       FontAttributes="Bold"
                                       Grid.Column="1"
                                       TextColor="#F9FAFB" />

                                <Label Text="{Binding Pc.Description, FallbackValue='Описание товара'}"
                                       Grid.Column="1"
                                       Grid.Row="1"
                                       TextColor="#64748B"
                                       LineBreakMode="TailTruncation" />

                                <Label Text="{Binding TotalPrice, StringFormat='Итого: {0:F2} ₽'}"
                                       Grid.Column="1"
                                       Grid.Row="2"
                                       TextColor="#10B981"
                                       FontAttributes="Bold" />

                                <Grid Grid.Column="2"
                                      Grid.RowSpan="3"
                                      RowDefinitions="Auto,Auto"
                                      RowSpacing="8"
                                      HorizontalOptions="End"
                                      VerticalOptions="Center">

                                    <Grid Grid.Row="0"
                                          ColumnDefinitions="32,Auto,32"
                                          ColumnSpacing="6"
                                          VerticalOptions="Center">

                                        <Button Text="−"
                                                FontSize="18"
                                                Padding="0"
                                                WidthRequest="32"
                                                HeightRequest="32"
                                                CornerRadius="16"
                                                BackgroundColor="#E5E7EB"
                                                TextColor="Black"
                                                Command="{Binding Source={x:Reference CartRoot}, Path=BindingContext.DecreaseQuantityCommand}"
                                                CommandParameter="{Binding .}" />

                                        <Label Grid.Column="1"
                                               Text="{Binding Quantity}"
                                               FontSize="16"
                                               HorizontalTextAlignment="Center"
                                               VerticalTextAlignment="Center"
                                               TextColor="#F9FAFB"
                                               WidthRequest="28" />

                                        <Button Grid.Column="2"
                                                Text="+"
                                                FontSize="18"
                                                Padding="0"
                                                WidthRequest="32"
                                                HeightRequest="32"
                                                CornerRadius="16"
                                                BackgroundColor="#E5E7EB"
                                                TextColor="Black"
                                                Command="{Binding Source={x:Reference CartRoot}, Path=BindingContext.IncreaseQuantityCommand}"
                                                CommandParameter="{Binding .}" />
                                    </Grid>

                                    <Button Grid.Row="1"
                                            Text="Удалить"
                                            Command="{Binding Source={x:Reference CartRoot}, Path=BindingContext.RemoveItemCommand}"
                                            CommandParameter="{Binding .}"
                                            BackgroundColor="#EF4444"
                                            TextColor="White"
                                            CornerRadius="8" />
                                </Grid>

                            </Grid>
                        </Frame>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
        </RefreshView>

        <Grid Grid.Row="1"
              Padding="15"
              BackgroundColor="#020617"
              RowDefinitions="Auto"
              ColumnDefinitions="*,Auto">
            <Label Text="{Binding TotalPrice, StringFormat='Итого: {0:F2} ₽'}"
                   FontSize="18"
                   FontAttributes="Bold"
                   TextColor="#10B981"
                   VerticalOptions="Center" />
            <Button Text="Оформить заказ"
                    Command="{Binding CheckoutCommand}"
                    BackgroundColor="#3B82F6"
                    TextColor="White"
                    CornerRadius="12"
                    WidthRequest="180"
                    HorizontalOptions="End" />
        </Grid>

    </Grid>
</ContentPage>
