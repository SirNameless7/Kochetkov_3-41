<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:vm="clr-namespace:KPO_Cursovoy.ViewModels"
    xmlns:conv="clr-namespace:KPO_Cursovoy.Converters"
    x:Class="KPO_Cursovoy.Views.BuildPcPage"
    Title="Собрать ПК">

    <ContentPage.Resources>
        <ResourceDictionary>
            <conv:StatusToColorConverter x:Key="StatusToColorConverter" />
            <conv:StockToColorConverter x:Key="StockToColorConverter" />
        </ResourceDictionary>
    </ContentPage.Resources>

    <RefreshView Command="{Binding RefreshCommand}" IsRefreshing="{Binding IsBusy}">
        <ScrollView>
            <VerticalStackLayout Padding="15" Spacing="15">
                <Label Text="Конструктор ПК" FontSize="24" FontAttributes="Bold" TextColor="Black" />
                <Label Text="Выберите компоненты для сборки ПК. Система проверит совместимость и позволит добавить сборку в корзину." TextColor="#64748B" Margin="0,0,0,15" />
                <Frame Padding="15" BorderColor="#E2E8F0" CornerRadius="12">
                    <VerticalStackLayout Spacing="10">
                        <Label Text="1. Выберите категорию компонента" FontSize="18" FontAttributes="Bold" />
                        <Picker ItemsSource="{Binding Categories}" SelectedItem="{Binding SelectedCategory}" ItemDisplayBinding="{Binding CategoryName}" Title="Категория" />
                    </VerticalStackLayout>
                </Frame>
                <Frame Padding="15" BorderColor="#E2E8F0" CornerRadius="12" IsVisible="{Binding IsComponentSelectionVisible}">
                    <VerticalStackLayout Spacing="10">
                        <Label Text="2. Выберите компонент" FontSize="18" FontAttributes="Bold" />

                        <CollectionView ItemsSource="{Binding AvailableComponents}" SelectionMode="Single">
                            <CollectionView.ItemTemplate>
                                <DataTemplate>
                                    <Frame BorderColor="{Binding Source={RelativeSource AncestorType={x:Type vm:BuildPcViewModel}}, Path=CompatibilityStatus, Converter={StaticResource StatusToColorConverter}}" Padding="15" Margin="0,5" CornerRadius="10" HasShadow="True">
                                        <Grid ColumnDefinitions="Auto,*" RowDefinitions="Auto,Auto,Auto,Auto">
                                            <Image Source="componenticon.png" WidthRequest="60" HeightRequest="60" Aspect="AspectFit" Grid.RowSpan="4" />
                                            <StackLayout Grid.Column="1">
                                                <Label Text="{Binding Name}" FontSize="16" FontAttributes="Bold" />
                                                <Label Text="{Binding CategoryName}" TextColor="#64748B" />
                                                <Label Text="{Binding Price, StringFormat='{0:F2} ₽'}" TextColor="#10B981" FontAttributes="Bold" />
                                                <Label Text="{Binding Stock, StringFormat='В наличии: {0} шт.'}" TextColor="{Binding Stock, Converter={StaticResource StockToColorConverter}}" />
                                            </StackLayout>
                                        </Grid>
                                    </Frame>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>

                        <Button Text="Добавить компонент" Command="{Binding Source={RelativeSource AncestorType={x:Type vm:BuildPcViewModel}}, Path=SelectComponentCommand}" BackgroundColor="#3B82F6" TextColor="White" CornerRadius="8" />
                    </VerticalStackLayout>
                </Frame>
                <Frame Padding="15" BorderColor="#3B82F6" CornerRadius="12" Margin="0,10,0,0">
                    <VerticalStackLayout Spacing="15">
                        <Label Text="3. Выбранные компоненты" FontSize="18" FontAttributes="Bold" />
                        <CollectionView ItemsSource="{Binding SelectedComponents}" SelectionMode="None">
                            <CollectionView.ItemTemplate>
                                <DataTemplate>
                                    <SwipeView>
                                        <SwipeView.RightItems>
                                            <SwipeItems>
                                                <SwipeItem Text="Удалить" BackgroundColor="#EF4444" Command="{Binding Source={RelativeSource AncestorType={x:Type vm:BuildPcViewModel}}, Path=RemoveComponentCommand}" CommandParameter="{Binding .}" />
                                            </SwipeItems>
                                        </SwipeView.RightItems>
                                        <Grid ColumnDefinitions="*,Auto" RowDefinitions="Auto,Auto,Auto" Padding="10">
                                            <Label Text="{Binding Name}" FontSize="16" FontAttributes="Bold" />
                                            <Label Text="{Binding CategoryName}" Grid.Row="1" TextColor="#64748B" />
                                            <Label Text="{Binding Price, StringFormat='{0:F2} ₽'}" Grid.Row="2" TextColor="#10B981" />
                                        </Grid>
                                    </SwipeView>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                    </VerticalStackLayout>
                </Frame>
                <Frame Padding="15" BorderColor="#10B981" CornerRadius="12" Margin="0,10,0,0" BackgroundColor="#F0FDF4">
                    <VerticalStackLayout Spacing="15">
                        <Button Text="Проверить совместимость" Command="{Binding CheckCompatibilityCommand}" BackgroundColor="#10B981" TextColor="White" CornerRadius="12" />
                        <Grid ColumnDefinitions="*,Auto" RowDefinitions="Auto,Auto" IsVisible="{Binding IsCompatibilityResultVisible}">
                            <Label Text="{Binding CompatibilityResult}" FontSize="16" TextColor="{Binding CompatibilityResultColor}" FontAttributes="Bold" />
                            <Button Text="Добавить сборку в корзину" Command="{Binding AddToCartCommand}" IsEnabled="{Binding IsCompatible}" BackgroundColor="#3B82F6" TextColor="White" CornerRadius="12" Grid.Row="1" />
                        </Grid>
                        <Label Text="{Binding TotalPrice, StringFormat='Итого: {0:F2} ₽'}" FontSize="20" FontAttributes="Bold" TextColor="#10B981" HorizontalOptions="Center" />
                    </VerticalStackLayout>
                </Frame>

            </VerticalStackLayout>
        </ScrollView>
    </RefreshView>
</ContentPage>
