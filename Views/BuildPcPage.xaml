<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:vm="clr-namespace:KPO_Cursovoy.ViewModels"
    xmlns:conv="clr-namespace:KPO_Cursovoy.Converters"
    x:Class="KPO_Cursovoy.Views.BuildPcPage"
    Title="Собрать ПК"
    BackgroundColor="#020617">

    <ContentPage.Resources>
        <ResourceDictionary>
            <conv:StatusToColorConverter x:Key="StatusToColorConverter" />
            <conv:StockToColorConverter x:Key="StockToColorConverter" />
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid RowDefinitions="Auto,*"
          BackgroundColor="#020617">
        <!-- Навигационные кнопки -->
        <Grid Grid.Row="0"
              ColumnDefinitions="Auto,Auto,Auto,Auto,Auto,*"
              Padding="16"
              BackgroundColor="#020617">

            <Button Text="Каталог"
                    Command="{Binding NavigateToCatalogCommand}"
                    BackgroundColor="#1F2933"
                    TextColor="#E5E7EB"
                    CornerRadius="10" />

            <Button Grid.Column="1"
                    Text="Собрать ПК"
                    Margin="8,0,0,0"
                    Command="{Binding NavigateToBuildPcCommand}"
                    BackgroundColor="#1F2933"
                    TextColor="#E5E7EB"
                    CornerRadius="10">
                <Button.Triggers>
                    <DataTrigger TargetType="Button"
                                 Binding="{Binding CurrentSection}"
                                 Value="Build">
                        <Setter Property="IsEnabled" Value="False" />
                        <Setter Property="BackgroundColor" Value="#2563EB" />
                        <Setter Property="TextColor" Value="White" />
                    </DataTrigger>
                </Button.Triggers>
            </Button>

            <Button Grid.Column="2"
                    Text="Корзина"
                    Margin="8,0,0,0"
                    Command="{Binding NavigateToCartCommand}"
                    BackgroundColor="#1F2933"
                    TextColor="#E5E7EB"
                    CornerRadius="10" />

            <Button Grid.Column="3"
                    Text="Заказы"
                    Margin="8,0,0,0"
                    Command="{Binding NavigateToOrdersCommand}"
                    BackgroundColor="#1F2933"
                    TextColor="#E5E7EB"
                    CornerRadius="10" />

            <Button Grid.Column="4"
                    Text="Профиль"
                    Margin="8,0,0,0"
                    Command="{Binding NavigateToProfileCommand}"
                    BackgroundColor="#1F2933"
                    TextColor="#E5E7EB"
                    CornerRadius="10" />
        </Grid>

        <!-- Основной контент -->
        <RefreshView Grid.Row="1"
                     Command="{Binding RefreshCommand}"
                     IsRefreshing="{Binding IsBusy}">
            <ScrollView>
                <VerticalStackLayout Padding="15" Spacing="15">

                    <Label Text="Конструктор ПК"
                           FontSize="24"
                           FontAttributes="Bold"
                           TextColor="#F9FAFB" />

                    <Label Text="Выберите компоненты для сборки ПК. Система проверит совместимость и позволит добавить сборку в корзину."
                           TextColor="#9CA3AF"
                           Margin="0,0,0,15" />

                    <!-- Выбор категории -->
                    <Frame Padding="15" BorderColor="#E2E8F0" CornerRadius="12">
                        <VerticalStackLayout Spacing="10">
                            <Label Text="1. Выберите категорию компонента"
                                   FontSize="18"
                                   FontAttributes="Bold"
                                   TextColor="#F9FAFB" />
                            <Picker ItemsSource="{Binding Categories}"
                                    SelectedItem="{Binding SelectedCategory, Mode=TwoWay}"
                                    ItemDisplayBinding="{Binding CategoryName}"
                                    Title="Категория" />
                        </VerticalStackLayout>
                    </Frame>

                    <!-- Выбор компонента -->
                    <Frame Padding="15"
                           BorderColor="#E2E8F0"
                           CornerRadius="12"
                           IsVisible="{Binding IsComponentSelectionVisible}">
                        <VerticalStackLayout Spacing="10">
                            <Label Text="2. Выберите компонент"
                                   FontSize="18"
                                   FontAttributes="Bold"
                                   TextColor="#F9FAFB" />

                            <CollectionView ItemsSource="{Binding AvailableComponents}"
                                            SelectionMode="Single"
                                            SelectedItem="{Binding SelectedAvailableComponent}">
                                <CollectionView.ItemTemplate>
                                    <DataTemplate>
                                        <Frame BorderColor="#64748B"
                                               Padding="15"
                                               Margin="0,5"
                                               CornerRadius="10"
                                               BackgroundColor="#020617">
                                            <Grid ColumnDefinitions="Auto,*"
                                                  RowDefinitions="Auto,Auto,Auto,Auto">
                                                <Image Source="componenticon.png"
                                                       WidthRequest="60"
                                                       HeightRequest="60"
                                                       Aspect="AspectFit"
                                                       Grid.RowSpan="4" />
                                                <StackLayout Grid.Column="1">
                                                    <Label Text="{Binding Name}"
                                                           FontSize="16"
                                                           FontAttributes="Bold"
                                                           TextColor="#F9FAFB" />
                                                    <Label Text="{Binding CategoryName}"
                                                           TextColor="#64748B" />
                                                    <Label Text="{Binding Price, StringFormat='{0:F2} ₽'}"
                                                           TextColor="#10B981"
                                                           FontAttributes="Bold" />
                                                    <Label Text="{Binding Stock, StringFormat='В наличии: {0} шт.'}"
                                                           TextColor="{Binding Stock, Converter={StaticResource StockToColorConverter}}" />
                                                </StackLayout>
                                            </Grid>
                                        </Frame>
                                    </DataTemplate>
                                </CollectionView.ItemTemplate>
                            </CollectionView>

                            <Button Text="Добавить компонент"
                                    Command="{Binding SelectComponentCommand}"
                                    CommandParameter="{Binding SelectedAvailableComponent}"
                                    BackgroundColor="#3B82F6"
                                    TextColor="White"
                                    CornerRadius="8" />
                        </VerticalStackLayout>
                    </Frame>

                    <!-- Выбранные компоненты -->
                    <Frame Padding="15"
                           BorderColor="#3B82F6"
                           CornerRadius="12"
                           Margin="0,10,0,0">
                        <VerticalStackLayout Spacing="15">
                            <Label Text="3. Выбранные компоненты"
                                   FontSize="18"
                                   FontAttributes="Bold"
                                   TextColor="#F9FAFB" />
                            <CollectionView ItemsSource="{Binding SelectedComponents}"
                                            SelectionMode="None">
                                <CollectionView.ItemTemplate>
                                    <DataTemplate>
                                        <SwipeView>
                                            <SwipeView.RightItems>
                                                <SwipeItems>
                                                    <SwipeItem Text="Удалить"
                                                               BackgroundColor="#EF4444"
                                                               Command="{Binding Source={RelativeSource AncestorType={x:Type vm:BuildPcViewModel}},
                                                                                 Path=RemoveComponentCommand}"
                                                               CommandParameter="{Binding .}" />
                                                </SwipeItems>
                                            </SwipeView.RightItems>
                                            <Grid ColumnDefinitions="*,Auto"
                                                  RowDefinitions="Auto,Auto,Auto"
                                                  Padding="10">
                                                <Label Text="{Binding Name}"
                                                       FontSize="16"
                                                       FontAttributes="Bold"
                                                       TextColor="#F9FAFB" />
                                                <Label Text="{Binding CategoryName}"
                                                       Grid.Row="1"
                                                       TextColor="#64748B" />
                                                <Label Text="{Binding Price, StringFormat='{0:F2} ₽'}"
                                                       Grid.Row="2"
                                                       TextColor="#10B981" />
                                            </Grid>
                                        </SwipeView>
                                    </DataTemplate>
                                </CollectionView.ItemTemplate>
                            </CollectionView>
                        </VerticalStackLayout>
                    </Frame>

                    <!-- Проверка совместимости и корзина -->
                    <Frame Padding="15"
                           BorderColor="#10B981"
                           CornerRadius="12"
                           Margin="0,10,0,0"
                           BackgroundColor="#022c22">
                        <VerticalStackLayout Spacing="15">
                            <Button Text="Проверить совместимость"
                                    Command="{Binding CheckCompatibilityCommand}"
                                    BackgroundColor="#10B981"
                                    TextColor="White"
                                    CornerRadius="12" />
                            <Grid ColumnDefinitions="*,Auto"
                                  RowDefinitions="Auto,Auto"
                                  IsVisible="{Binding IsCompatibilityResultVisible}">
                                <Label Text="{Binding CompatibilityResult}"
                                       FontSize="16"
                                       TextColor="{Binding CompatibilityResultColor}"
                                       FontAttributes="Bold" />
                                <Button Text="Добавить сборку в корзину"
                                        Command="{Binding AddToCartCommand}"
                                        IsEnabled="{Binding IsCompatible}"
                                        BackgroundColor="#3B82F6"
                                        TextColor="White"
                                        CornerRadius="12"
                                        Grid.Row="1" />
                            </Grid>
                            <Label Text="{Binding TotalPrice, StringFormat='Итого: {0:F2} ₽'}"
                                   FontSize="20"
                                   FontAttributes="Bold"
                                   TextColor="#10B981"
                                   HorizontalOptions="Center" />
                        </VerticalStackLayout>
                    </Frame>

                </VerticalStackLayout>
            </ScrollView>
        </RefreshView>
    </Grid>
</ContentPage>
